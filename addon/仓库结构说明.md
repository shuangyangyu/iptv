# Home Assistant Addon 仓库结构说明

## 当前结构（多 addon 仓库）

```
iptv/
├── repository.json          # 仓库标识
├── addon/                   # Addon 目录
│   ├── config.yaml
│   ├── Dockerfile
│   ├── run.sh
│   ├── README.md
│   └── ...
├── iptv_sever/             # 项目代码
└── ...
```

**优点：**
- 项目代码和 addon 在同一个仓库
- 便于管理

**缺点：**
- 需要 repository.json
- 可能某些 HA 版本对多 addon 仓库支持不完善

## 独立 Addon 仓库结构（推荐）

如果当前方式持续失败，可以创建独立的 addon 仓库：

### 结构：

```
iptv-addon/                 # 独立的 addon 仓库
├── config.yaml            # 在根目录
├── Dockerfile             # 在根目录
├── run.sh                 # 在根目录
├── README.md
└── CHANGELOG.md
```

**优点：**
- 更符合 HA addon 单仓库标准
- 不需要 repository.json
- 结构更简单

**缺点：**
- 需要维护两个仓库
- 代码需要同步

## 创建独立仓库的步骤

### 1. 创建新仓库

```bash
# 在 GitHub 创建新仓库：iptv-addon
# 或使用现有仓库
```

### 2. 复制 addon 文件到根目录

```bash
# 从当前仓库复制
cp addon/config.yaml iptv-addon/
cp addon/Dockerfile iptv-addon/
cp addon/run.sh iptv-addon/
cp addon/README.md iptv-addon/
cp addon/CHANGELOG.md iptv-addon/
```

### 3. 修改 Dockerfile

需要调整 COPY 路径，因为代码在另一个仓库：

**选项 A：使用 Git submodule**
```dockerfile
# 在 Dockerfile 中
RUN git clone https://github.com/shuangyangyu/iptv.git /tmp/iptv && \
    cp -r /tmp/iptv/iptv_sever /app/iptv_sever && \
    rm -rf /tmp/iptv
```

**选项 B：在构建时包含代码**
- 将 iptv_sever 目录也复制到 addon 仓库
- 或使用多阶段构建

**选项 C：使用预构建镜像**
- 先构建包含代码的基础镜像
- addon 只包含配置和启动脚本

### 4. 更新 config.yaml

确保所有路径和配置正确。

## 当前问题的解决方案

### 方案 1：先解决网络问题（推荐）

1. **检查网络连接**
   ```bash
   # 在 HA 设备上测试
   ping github.com
   curl -I https://github.com
   ```

2. **配置代理（如果需要）**
   - 在 HA 或 Supervisor 中配置代理

3. **等待重试**
   - SSL 错误可能是临时问题

### 方案 2：创建独立仓库

如果网络问题持续，可以：
1. 创建独立的 addon 仓库
2. 使用 Git submodule 或包含代码
3. 简化结构

### 方案 3：使用 docker-compose（最简单）

如果 addon 安装一直失败，直接使用 docker-compose：

```bash
# 在 HA 设备上
cd /path/to/iptv
docker-compose up -d
```

功能完全相同，不需要通过 Supervisor 安装。

## 建议

1. **先尝试解决网络问题**
   - 这是最可能的原因
   - 检查 HA 设备的网络连接

2. **如果网络问题持续**
   - 考虑创建独立的 addon 仓库
   - 或者直接使用 docker-compose

3. **查看详细日志**
   - 通过 SSH 运行：`ha supervisor logs | grep -A 50 "iptv"`
   - 获取具体的构建错误信息

## 需要帮助？

如果决定创建独立仓库，我可以帮你：
1. 调整 Dockerfile 以支持独立仓库结构
2. 创建新的仓库结构
3. 配置 Git submodule（如果需要）

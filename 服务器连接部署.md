# 服务器连接和部署指南

## SSH 连接服务器

### 基本连接

```bash
# 连接到服务器
ssh root@192.168.1.249

# 或使用其他用户名
ssh username@192.168.1.249

# 指定端口（如果不是默认 22 端口）
ssh -p 2222 root@192.168.1.249
```

### 配置 SSH 密钥（免密登录）

#### 1. 生成 SSH 密钥（如果还没有）

```bash
# 在本地生成密钥对
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 按提示操作，默认保存在 ~/.ssh/id_rsa
```

#### 2. 复制公钥到服务器

```bash
# 方法 1：使用 ssh-copy-id（推荐）
ssh-copy-id root@192.168.1.249

# 方法 2：手动复制
cat ~/.ssh/id_rsa.pub | ssh root@192.168.1.249 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

#### 3. 测试免密登录

```bash
ssh root@192.168.1.249
# 应该可以直接登录，不需要输入密码
```

### SSH 配置文件（可选）

创建 `~/.ssh/config` 文件，简化连接：

```bash
# 编辑 SSH 配置文件
nano ~/.ssh/config
```

添加以下内容：

```
Host iptv-server
    HostName 192.168.1.249
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa
```

然后就可以使用：

```bash
ssh iptv-server
```

## 部署方法

### 方法 1：使用部署脚本（推荐）

```bash
# 在项目根目录执行
./deploy_to_ha.sh

# 或指定服务器信息
HA_HOST=192.168.1.249 HA_USER=root ./deploy_to_ha.sh
```

### 方法 2：手动部署

#### 步骤 1：同步代码到服务器

```bash
# 使用 rsync（推荐，支持增量同步）
rsync -avz --progress \
    --exclude='.git' \
    --exclude='venv' \
    --exclude='node_modules' \
    --exclude='__pycache__' \
    --exclude='*.pyc' \
    --exclude='文档' \
    --exclude='iptv_sever/tests' \
    --exclude='scripts' \
    ./ root@192.168.1.249:/opt/iptv

# 或使用 scp（完整复制）
scp -r ./ root@192.168.1.249:/opt/iptv
```

#### 步骤 2：SSH 到服务器并启动

```bash
# 连接到服务器
ssh root@192.168.1.249

# 进入项目目录
cd /opt/iptv

# 停止旧容器（如果存在）
docker-compose down

# 重新构建镜像
docker-compose build --no-cache

# 启动服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
```

### 方法 3：在服务器上直接 Git 克隆

```bash
# SSH 到服务器
ssh root@192.168.1.249

# 克隆项目
cd /opt
git clone https://github.com/shuangyangyu/iptv.git
cd iptv

# 构建并启动
docker-compose build
docker-compose up -d
```

## 常用操作

### 查看服务状态

```bash
# SSH 到服务器
ssh root@192.168.1.249

# 进入项目目录
cd /opt/iptv

# 查看容器状态
docker-compose ps

# 查看服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

### 重启服务

```bash
# 在服务器上
cd /opt/iptv
docker-compose restart

# 或重启特定服务
docker-compose restart backend
docker-compose restart frontend
```

### 停止服务

```bash
cd /opt/iptv
docker-compose down
```

### 更新服务

```bash
# 方法 1：在服务器上直接更新
ssh root@192.168.1.249
cd /opt/iptv
git pull origin master
docker-compose build --no-cache
docker-compose up -d

# 方法 2：从本地重新同步
# 在本地更新代码后
rsync -avz --progress \
    --exclude='.git' \
    --exclude='venv' \
    --exclude='node_modules' \
    ./ root@192.168.1.249:/opt/iptv

# 然后在服务器上重新构建
ssh root@192.168.1.249 "cd /opt/iptv && docker-compose build --no-cache && docker-compose up -d"
```

## 故障排查

### 1. SSH 连接失败

```bash
# 检查网络连接
ping 192.168.1.249

# 检查 SSH 服务是否运行
ssh -v root@192.168.1.249

# 检查防火墙
# 在服务器上
sudo ufw status
sudo iptables -L
```

### 2. 权限问题

```bash
# 确保有执行权限
chmod +x deploy_to_ha.sh

# 确保 Docker 权限
sudo usermod -aG docker $USER
# 需要重新登录生效
```

### 3. 端口被占用

```bash
# 在服务器上检查端口
lsof -i :80
lsof -i :8088
lsof -i :4022

# 停止占用端口的服务
```

### 4. 查看详细错误

```bash
# 查看 Docker 日志
docker-compose logs backend
docker-compose logs frontend

# 进入容器检查
docker-compose exec backend bash
docker-compose exec frontend sh
```

## 访问服务

部署成功后，访问：

- **前端界面**: http://192.168.1.249
- **后端 API**: http://192.168.1.249:8088
- **API 文档**: http://192.168.1.249:8088/docs

## 快速命令参考

```bash
# 连接服务器
ssh root@192.168.1.249

# 部署（从本地）
./deploy_to_ha.sh

# 查看日志（在服务器上）
cd /opt/iptv && docker-compose logs -f

# 重启服务（在服务器上）
cd /opt/iptv && docker-compose restart

# 停止服务（在服务器上）
cd /opt/iptv && docker-compose down

# 更新服务（在服务器上）
cd /opt/iptv && git pull && docker-compose build --no-cache && docker-compose up -d
```
